---
import { type CollectionEntry, getCollection } from 'astro:content';
import {
  DEFAULT_LANGUAGE,
  defaultLanguage,
  languages,
  type SupportedLanguage,
} from '@/i18n/config';
import { useTranslations } from '@/i18n/utils';

type Post = CollectionEntry<'posts'>;

const lang = Astro.currentLocale || DEFAULT_LANGUAGE;
const t = useTranslations(lang);
const locale =
  languages[lang as SupportedLanguage]?.locale || defaultLanguage.locale;
const isProd = import.meta.env.PROD;

const postsByYear: Record<number, Post[]> = {};
const langPrefix = `${lang}/`;

for (const p of await getCollection('posts')) {
  if (!p.id.startsWith(langPrefix)) continue;
  if (isProd && p.data.draft) continue;

  const year = p.data.pubDate.getFullYear();
  (postsByYear[year] ??= []).push(p);
}

const yearEntries = Object.entries(postsByYear)
  .sort(([a], [b]) => Number(b) - Number(a))
  .map(([year, posts]) => [
    year,
    posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
  ]) as [string, Post[]][];

function getPostUrl(post: Post): string {
  const slug = post.id.replace(langPrefix, '').replace(/\.mdx?$/, '');
  return `/${lang}/${slug}`;
}
---

<section class='group flex flex-col gap-2 text-sm'>
  {
    yearEntries.map(([year, posts], index) => (
      <>
        {index > 0 && (
          <hr class='dark:border-text-secondary/10 border-border-color border-t' />
        )}
        <div class='flex gap-8'>
          <div class='text-text-secondary w-16 shrink-0 font-medium'>{year}</div>
          <div class='flex flex-1 flex-col gap-2'>
            {posts.map(post => (
              <a
                href={getPostUrl(post)}
                class='post-item flex items-center justify-between gap-4 transition-colors group-hover:opacity-[0.45] hover:!opacity-100 focus:!opacity-100 motion-safe:transition-opacity'
              >
                <h2 class='text-text-primary font-[460] transition-colors'>
                  {post.data.title}
                  {post.data.draft && !isProd && (
                    <span class='ml-2 rounded bg-yellow-200 px-1 py-0.5 text-xs text-yellow-800'>
                      {t('posts.draft')}
                    </span>
                  )}
                </h2>
                <time
                  datetime={post.data.pubDate.toISOString()}
                  class='text-text-secondary flex shrink-0 items-center gap-0.5 tracking-[-0.06rem] tabular-nums opacity-80'
                >
                  <span>
                    {post.data.pubDate.toLocaleDateString(locale, { day: '2-digit' })}
                  </span>
                  <span class='opacity-50'>/</span>
                  <span>
                    {post.data.pubDate.toLocaleDateString(locale, { month: '2-digit' })}
                  </span>
                </time>
              </a>
            ))}
          </div>
        </div>
      </>
    ))
  }
</section>
